library(psych)
library(flextable)
library(officer)
library(lubridate)
library(ggplot2)
library(stringr)
library(tidyr)
library(scales)
#IMPORT DATA
bezettingsregistraties <- read_csv("data/bezettingsregistraties.csv")
materieelplanning <- read_csv("data/materieelplanning.csv")
concessie_kpis <- read_csv("data/concessie_kpis.csv")
station_metadata <- read_csv("data/station_metadata.csv")
trein_dienstregeling <- read_csv("data/trein_dienstregeling.csv")
# Check op duplicates op de belangrijkste keys (trein_id + dienst_datum)
trein_dienstregeling %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
bezettingsregistraties %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
materieelplanning %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
trein_dienstregeling2 <- trein_dienstregeling %>%
mutate(
dienst_datum = as.Date(dienst_datum),
vertrek_uur = as.integer(vertrek_uur),
traject = as.character(traject),
vertrek_station = as.character(vertrek_station),
aankomst_station = as.character(aankomst_station)
)
bezettingsregistraties2 <- bezettingsregistraties %>%
mutate(
dienst_datum = as.Date(dienst_datum),
reizigers = as.integer(reizigers),
zitplaatsen_beschikbaar = as.integer(zitplaatsen_beschikbaar),
bezettingsgraad_pct = as.numeric(bezettingsgraad_pct)
)
materieelplanning2 <- materieelplanning %>%
mutate(
dienst_datum = as.Date(dienst_datum),
materieeltype = as.character(materieeltype),
aantal_bakken = as.integer(aantal_bakken),
totaal_zitplaatsen = as.integer(totaal_zitplaatsen),
staanplaatsen = as.integer(staanplaatsen)
)
# 3) Samenvoegen naar 1 analyse-tabel (fact)
fact <- trein_dienstregeling2 %>%
left_join(bezettingsregistraties2, by = c("trein_id", "dienst_datum")) %>%
left_join(materieelplanning2, by = c("trein_id", "dienst_datum")) %>%
mutate(
weekday = wday(dienst_datum, label = TRUE, abbr = TRUE, week_start = 1),
week = isoweek(dienst_datum),
month = floor_date(dienst_datum, "month"),
tijdvak = case_when(
vertrek_uur %in% 7:9 ~ "Ochtendspits",
vertrek_uur %in% 16:18 ~ "Avondspits",
TRUE ~ "Dal"
)
) %>%
mutate(
zitplaatsen = coalesce(totaal_zitplaatsen, zitplaatsen_beschikbaar),
bezettingsgraad = 100 * reizigers / zitplaatsen,
overbezet = if_else(reizigers > zitplaatsen, 1L, 0L),
overbezettingsgraad = 100 * pmax(0, (reizigers - zitplaatsen) / zitplaatsen),
zitplaatskans_pct = 100 * pmin(1, zitplaatsen / reizigers),
buffer_zitplaatsen = zitplaatsen - reizigers
)
View(fact)
View(fact)
# 5) KPI’s overall
kpi_overall <- fact %>%
summarise(
ritten = n(),
reizigers_totaal = sum(reizigers, na.rm = TRUE),
zitplaatsen_totaal = sum(zitplaatsen, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
gemiddelde_overbezettingsgraad = mean(overbezettingsgraad, na.rm = TRUE),
zitplaatskans_reizigers_pct = weighted.mean(zitplaatskans_pct, w = reizigers, na.rm = TRUE)
)
kpi_overall
# 6) KPI’s per tijdvak (spits vs dal)
kpi_tijdvak <- fact %>%
group_by(tijdvak) %>%
summarise(
ritten = n(),
reizigers = sum(reizigers, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
zitplaatskans_reizigers_pct =
100 * sum(pmin(zitplaatsen, reizigers), na.rm = TRUE) /
sum(reizigers, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(reizigers))
kpi_tijdvak
kpi_tijdvak
View(kpi_tijdvak)
View(kpi_tijdvak)
#IMPORT DATA
bezettingsregistraties <- read_csv("data/bezettingsregistraties.csv")
materieelplanning <- read_csv("data/materieelplanning.csv")
concessie_kpis <- read_csv("data/concessie_kpis.csv")
station_metadata <- read_csv("data/station_metadata.csv")
trein_dienstregeling <- read_csv("data/trein_dienstregeling.csv")
# 1) Datacontrole (snelle sanity checks)
glimpse(trein_dienstregeling)
glimpse(bezettingsregistraties)
glimpse(materieelplanning)
glimpse(station_metadata)
glimpse(concessie_kpis)
# Check op duplicates op de belangrijkste keys (trein_id + dienst_datum)
trein_dienstregeling %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
bezettingsregistraties %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
materieelplanning %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
# 2) Types goed zetten
trein_dienstregeling2 <- trein_dienstregeling %>%
mutate(
dienst_datum = as.Date(dienst_datum),
vertrek_uur = as.integer(vertrek_uur),
traject = as.character(traject),
vertrek_station = as.character(vertrek_station),
aankomst_station = as.character(aankomst_station)
)
bezettingsregistraties2 <- bezettingsregistraties %>%
mutate(
dienst_datum = as.Date(dienst_datum),
reizigers = as.integer(reizigers),
zitplaatsen_beschikbaar = as.integer(zitplaatsen_beschikbaar),
bezettingsgraad_pct = as.numeric(bezettingsgraad_pct)
)
materieelplanning2 <- materieelplanning %>%
mutate(
dienst_datum = as.Date(dienst_datum),
materieeltype = as.character(materieeltype),
aantal_bakken = as.integer(aantal_bakken),
totaal_zitplaatsen = as.integer(totaal_zitplaatsen),
staanplaatsen = as.integer(staanplaatsen)
)
# 3) Samenvoegen naar 1 analyse-tabel (fact)
fact <- trein_dienstregeling2 %>%
left_join(bezettingsregistraties2, by = c("trein_id", "dienst_datum")) %>%
left_join(materieelplanning2, by = c("trein_id", "dienst_datum")) %>%
mutate(
weekday = wday(dienst_datum, label = TRUE, abbr = TRUE, week_start = 1),
week = isoweek(dienst_datum),
month = floor_date(dienst_datum, "month"),
tijdvak = case_when(
vertrek_uur %in% 7:9 ~ "Ochtendspits",
vertrek_uur %in% 16:18 ~ "Avondspits",
TRUE ~ "Dal"
)
) %>%
mutate(
zitplaatsen = coalesce(totaal_zitplaatsen, zitplaatsen_beschikbaar),
bezettingsgraad = 100 * reizigers / zitplaatsen,
overbezet = if_else(reizigers > zitplaatsen, 1L, 0L),
overbezettingsgraad = 100 * pmax(0, (reizigers - zitplaatsen) / zitplaatsen),
zitplaatskans_pct = 100 * pmin(1, zitplaatsen / reizigers),
buffer_zitplaatsen = zitplaatsen - reizigers
)
# 4) Check op NA’s na joins (indicatie van ontbrekende koppelingen)
colSums(is.na(fact[c("reizigers","zitplaatsen","materieeltype","vertrek_station","aankomst_station")]))
# 5) KPI’s overall
kpi_overall <- fact %>%
summarise(
ritten = n(),
reizigers_totaal = sum(reizigers, na.rm = TRUE),
zitplaatsen_totaal = sum(zitplaatsen, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
gemiddelde_overbezettingsgraad = mean(overbezettingsgraad, na.rm = TRUE),
zitplaatskans_reizigers_pct = weighted.mean(zitplaatskans_pct, w = reizigers, na.rm = TRUE)
)
kpi_overall
# 6) KPI’s per tijdvak (spits vs dal)
kpi_tijdvak <- fact %>%
group_by(tijdvak) %>%
summarise(
ritten = n(),
reizigers = sum(reizigers, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
zitplaatskans_reizigers_pct =
100 * sum(pmin(zitplaatsen, reizigers), na.rm = TRUE) /
sum(reizigers, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(reizigers))
kpi_tijdvak
View(kpi_tijdvak)
View(kpi_tijdvak)
#IMPORT DATA
bezettingsregistraties <- read_csv("data/bezettingsregistraties.csv")
materieelplanning <- read_csv("data/materieelplanning.csv")
concessie_kpis <- read_csv("data/concessie_kpis.csv")
station_metadata <- read_csv("data/station_metadata.csv")
trein_dienstregeling <- read_csv("data/trein_dienstregeling.csv")
# 1) Datacontrole (snelle sanity checks)
glimpse(trein_dienstregeling)
glimpse(bezettingsregistraties)
glimpse(materieelplanning)
glimpse(station_metadata)
glimpse(concessie_kpis)
# Check op duplicates op de belangrijkste keys (trein_id + dienst_datum)
trein_dienstregeling %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
bezettingsregistraties %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
materieelplanning %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
# 2) Types goed zetten
trein_dienstregeling2 <- trein_dienstregeling %>%
mutate(
dienst_datum = as.Date(dienst_datum),
vertrek_uur = as.integer(vertrek_uur),
traject = as.character(traject),
vertrek_station = as.character(vertrek_station),
aankomst_station = as.character(aankomst_station)
)
bezettingsregistraties2 <- bezettingsregistraties %>%
mutate(
dienst_datum = as.Date(dienst_datum),
reizigers = as.integer(reizigers),
zitplaatsen_beschikbaar = as.integer(zitplaatsen_beschikbaar),
bezettingsgraad_pct = as.numeric(bezettingsgraad_pct)
)
materieelplanning2 <- materieelplanning %>%
mutate(
dienst_datum = as.Date(dienst_datum),
materieeltype = as.character(materieeltype),
aantal_bakken = as.integer(aantal_bakken),
totaal_zitplaatsen = as.integer(totaal_zitplaatsen),
staanplaatsen = as.integer(staanplaatsen)
)
# 3) Samenvoegen naar 1 analyse-tabel (fact)
fact <- trein_dienstregeling2 %>%
left_join(bezettingsregistraties2, by = c("trein_id", "dienst_datum")) %>%
left_join(materieelplanning2, by = c("trein_id", "dienst_datum")) %>%
mutate(
weekday = wday(dienst_datum, label = TRUE, abbr = TRUE, week_start = 1),
week = isoweek(dienst_datum),
month = floor_date(dienst_datum, "month"),
tijdvak = case_when(
vertrek_uur %in% 7:9 ~ "Ochtendspits",
vertrek_uur %in% 16:18 ~ "Avondspits",
TRUE ~ "Dal"
)
) %>%
mutate(
zitplaatsen = coalesce(totaal_zitplaatsen, zitplaatsen_beschikbaar),
bezettingsgraad = 100 * reizigers / zitplaatsen,
overbezet = if_else(reizigers > zitplaatsen, 1L, 0L),
overbezettingsgraad = 100 * pmax(0, (reizigers - zitplaatsen) / zitplaatsen),
zitplaatskans_pct = 100 * pmin(1, zitplaatsen / reizigers),
buffer_zitplaatsen = zitplaatsen - reizigers
)
# 4) Check op NA’s na joins (indicatie van ontbrekende koppelingen)
colSums(is.na(fact[c("reizigers","zitplaatsen","materieeltype","vertrek_station","aankomst_station")]))
# 5) KPI’s overall
kpi_overall <- fact %>%
summarise(
ritten = n(),
reizigers_totaal = sum(reizigers, na.rm = TRUE),
zitplaatsen_totaal = sum(zitplaatsen, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
gemiddelde_overbezettingsgraad = mean(overbezettingsgraad, na.rm = TRUE),
zitplaatskans_reizigers_pct = weighted.mean(zitplaatskans_pct, w = reizigers, na.rm = TRUE)
)
kpi_overall
# 6) KPI’s per tijdvak (spits vs dal)
kpi_tijdvak <- fact %>%
group_by(tijdvak) %>%
summarise(
ritten = n(),
reizigers = sum(reizigers, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
zitplaatskans_reizigers_pct =
100 * sum(pmin(zitplaatsen, reizigers), na.rm = TRUE) /
sum(reizigers, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(reizigers))
kpi_tijdvak
View(kpi_tijdvak)
View(kpi_tijdvak)
#IMPORT DATA
bezettingsregistraties <- read_csv("data/bezettingsregistraties.csv")
materieelplanning <- read_csv("data/materieelplanning.csv")
concessie_kpis <- read_csv("data/concessie_kpis.csv")
station_metadata <- read_csv("data/station_metadata.csv")
trein_dienstregeling <- read_csv("data/trein_dienstregeling.csv")
# 1) Datacontrole (snelle sanity checks)
glimpse(trein_dienstregeling)
glimpse(bezettingsregistraties)
glimpse(materieelplanning)
glimpse(station_metadata)
glimpse(concessie_kpis)
# Check op duplicates op de belangrijkste keys (trein_id + dienst_datum)
trein_dienstregeling %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
bezettingsregistraties %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
materieelplanning %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
# 2) Types goed zetten
trein_dienstregeling2 <- trein_dienstregeling %>%
mutate(
dienst_datum = as.Date(dienst_datum),
vertrek_uur = as.integer(vertrek_uur),
traject = as.character(traject),
vertrek_station = as.character(vertrek_station),
aankomst_station = as.character(aankomst_station)
)
bezettingsregistraties2 <- bezettingsregistraties %>%
mutate(
dienst_datum = as.Date(dienst_datum),
reizigers = as.integer(reizigers),
zitplaatsen_beschikbaar = as.integer(zitplaatsen_beschikbaar),
bezettingsgraad_pct = as.numeric(bezettingsgraad_pct)
)
materieelplanning2 <- materieelplanning %>%
mutate(
dienst_datum = as.Date(dienst_datum),
materieeltype = as.character(materieeltype),
aantal_bakken = as.integer(aantal_bakken),
totaal_zitplaatsen = as.integer(totaal_zitplaatsen),
staanplaatsen = as.integer(staanplaatsen)
)
# 3) Samenvoegen naar 1 analyse-tabel (fact)
fact <- trein_dienstregeling2 %>%
left_join(bezettingsregistraties2, by = c("trein_id", "dienst_datum")) %>%
left_join(materieelplanning2, by = c("trein_id", "dienst_datum")) %>%
mutate(
weekday = wday(dienst_datum, label = TRUE, abbr = TRUE, week_start = 1),
week = isoweek(dienst_datum),
month = floor_date(dienst_datum, "month"),
tijdvak = case_when(
vertrek_uur %in% 7:9 ~ "Ochtendspits",
vertrek_uur %in% 16:18 ~ "Avondspits",
TRUE ~ "Dal"
)
) %>%
mutate(
zitplaatsen = coalesce(totaal_zitplaatsen, zitplaatsen_beschikbaar),
bezettingsgraad = 100 * reizigers / zitplaatsen,
overbezet = if_else(reizigers > zitplaatsen, 1L, 0L),
overbezettingsgraad = 100 * pmax(0, (reizigers - zitplaatsen) / zitplaatsen),
zitplaatskans_pct = 100 * pmin(1, zitplaatsen / reizigers),
buffer_zitplaatsen = zitplaatsen - reizigers
)
# 4) Check op NA’s na joins (indicatie van ontbrekende koppelingen)
colSums(is.na(fact[c("reizigers","zitplaatsen","materieeltype","vertrek_station","aankomst_station")]))
# 5) KPI’s overall
kpi_overall <- fact %>%
summarise(
ritten = n(),
reizigers_totaal = sum(reizigers, na.rm = TRUE),
zitplaatsen_totaal = sum(zitplaatsen, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
gemiddelde_overbezettingsgraad = mean(overbezettingsgraad, na.rm = TRUE),
zitplaatskans_reizigers_pct = weighted.mean(zitplaatskans_pct, w = reizigers, na.rm = TRUE)
)
kpi_overall
# 6) KPI’s per tijdvak (spits vs dal)
kpi_tijdvak <- fact %>%
group_by(tijdvak) %>%
summarise(
ritten = n(),
reizigers = sum(reizigers, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
zitplaatskans_reizigers_pct =
100 * sum(pmin(zitplaatsen, reizigers), na.rm = TRUE) /
sum(reizigers, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(reizigers))
kpi_tijdvak
View(kpi_tijdvak)
View(kpi_tijdvak)
#IMPORT DATA
bezettingsregistraties <- read_csv("data/bezettingsregistraties.csv")
materieelplanning <- read_csv("data/materieelplanning.csv")
concessie_kpis <- read_csv("data/concessie_kpis.csv")
station_metadata <- read_csv("data/station_metadata.csv")
trein_dienstregeling <- read_csv("data/trein_dienstregeling.csv")
# 1) Datacontrole (snelle sanity checks)
glimpse(trein_dienstregeling)
glimpse(bezettingsregistraties)
glimpse(materieelplanning)
glimpse(station_metadata)
glimpse(concessie_kpis)
# Check op duplicates op de belangrijkste keys (trein_id + dienst_datum)
trein_dienstregeling %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
bezettingsregistraties %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
materieelplanning %>%
count(trein_id, dienst_datum) %>%
filter(n > 1) %>%
head()
# 2) Types goed zetten
trein_dienstregeling2 <- trein_dienstregeling %>%
mutate(
dienst_datum = as.Date(dienst_datum),
vertrek_uur = as.integer(vertrek_uur),
traject = as.character(traject),
vertrek_station = as.character(vertrek_station),
aankomst_station = as.character(aankomst_station)
)
bezettingsregistraties2 <- bezettingsregistraties %>%
mutate(
dienst_datum = as.Date(dienst_datum),
reizigers = as.integer(reizigers),
zitplaatsen_beschikbaar = as.integer(zitplaatsen_beschikbaar),
bezettingsgraad_pct = as.numeric(bezettingsgraad_pct)
)
materieelplanning2 <- materieelplanning %>%
mutate(
dienst_datum = as.Date(dienst_datum),
materieeltype = as.character(materieeltype),
aantal_bakken = as.integer(aantal_bakken),
totaal_zitplaatsen = as.integer(totaal_zitplaatsen),
staanplaatsen = as.integer(staanplaatsen)
)
# 3) Samenvoegen naar 1 analyse-tabel (fact)
fact <- trein_dienstregeling2 %>%
left_join(bezettingsregistraties2, by = c("trein_id", "dienst_datum")) %>%
left_join(materieelplanning2, by = c("trein_id", "dienst_datum")) %>%
mutate(
weekday = wday(dienst_datum, label = TRUE, abbr = TRUE, week_start = 1),
week = isoweek(dienst_datum),
month = floor_date(dienst_datum, "month"),
tijdvak = case_when(
vertrek_uur %in% 7:9 ~ "Ochtendspits",
vertrek_uur %in% 16:18 ~ "Avondspits",
TRUE ~ "Dal"
)
) %>%
mutate(
zitplaatsen = coalesce(totaal_zitplaatsen, zitplaatsen_beschikbaar),
bezettingsgraad = 100 * reizigers / zitplaatsen,
overbezet = if_else(reizigers > zitplaatsen, 1L, 0L),
overbezettingsgraad = 100 * pmax(0, (reizigers - zitplaatsen) / zitplaatsen),
zitplaatskans_pct = 100 * pmin(1, zitplaatsen / reizigers),
buffer_zitplaatsen = zitplaatsen - reizigers
)
# 4) Check op NA’s na joins (indicatie van ontbrekende koppelingen)
colSums(is.na(fact[c("reizigers","zitplaatsen","materieeltype","vertrek_station","aankomst_station")]))
# 5) KPI’s overall
kpi_overall <- fact %>%
summarise(
ritten = n(),
reizigers_totaal = sum(reizigers, na.rm = TRUE),
zitplaatsen_totaal = sum(zitplaatsen, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
gemiddelde_overbezettingsgraad = mean(overbezettingsgraad, na.rm = TRUE),
zitplaatskans_reizigers_pct = weighted.mean(zitplaatskans_pct, w = reizigers, na.rm = TRUE)
)
kpi_overall
# 6) KPI’s per tijdvak (spits vs dal)
kpi_tijdvak <- fact %>%
group_by(tijdvak) %>%
summarise(
ritten = n(),
reizigers = sum(reizigers, na.rm = TRUE),
pct_ritten_overbezet = mean(overbezet, na.rm = TRUE) * 100,
zitplaatskans_reizigers_pct =
100 * sum(pmin(zitplaatsen, reizigers), na.rm = TRUE) /
sum(reizigers, na.rm = TRUE),
gemiddelde_bezettingsgraad = mean(bezettingsgraad, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(reizigers))
kpi_tijdvak
View(kpi_tijdvak)
View(kpi_tijdvak)
